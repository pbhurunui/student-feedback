<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackboard Teaching Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Blackboard Theme Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2E5041; /* Deep green-black for the board */
            color: #FFFDE7; /* Chalk white/yellow */
            min-height: 100vh;
            padding: 2rem 0;
            display: flex;
            justify-content: center;
        }

        .chalkboard-container {
            width: 100%;
            max-width: 1200px;
            padding: 2rem;
            border: 12px solid #5C3A21; /* Wooden frame */
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.4);
        }

        .chalk {
            color: #FFFDE7;
        }

        .chalk-header {
            color: #F0E68C; /* Slightly brighter yellow for headings */
            text-shadow: 1px 1px 0 #000;
            border-bottom: 2px solid #A0A0A0; /* Chalk line */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .chalk-input {
            background-color: rgba(0, 0, 0, 0.3); /* Transparent dark overlay */
            border: 2px solid #5C3A21;
            color: #FFFDE7;
            resize: vertical;
            min-height: 200px;
            box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.2);
        }

        .chalk-button {
            background-color: #5C3A21; /* Brown button */
            color: #FFFDE7;
            text-shadow: 1px 1px 0 #000;
            border: 2px solid #7D5B3C;
            transition: all 0.1s;
            box-shadow: 2px 2px 0 #3C2314;
        }

        .chalk-button:hover {
            background-color: #7D5B3C;
            box-shadow: 1px 1px 0 #3C2314;
            transform: translateY(1px) translateX(1px);
        }

        .chalk-button:active {
            box-shadow: none;
            transform: translateY(2px) translateX(2px);
        }

        .bar-container {
            height: 12px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .bar {
            background-color: #A0A0A0; /* Chalk Gray bar */
            height: 100%;
            transition: width 0.5s ease-out;
            border-radius: 6px;
        }

        /* Markdown Styling for LLM Output */
        #analysis-output h1 {
            color: #F0E68C;
            font-size: 1.5rem;
            margin-top: 2rem;
            border-bottom: 1px dashed #A0A0A0;
            padding-bottom: 0.5rem;
        }
        #analysis-output h2 {
            color: #FFFDE7;
            font-size: 1.25rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        #analysis-output p {
            margin-bottom: 1rem;
        }
        #analysis-output ul {
            list-style-type: none;
            padding-left: 1rem;
        }
        #analysis-output li:before {
            content: "•";
            color: #A0A0A0;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="chalkboard-container">
    <h1 class="text-3xl font-bold chalk-header mb-8 text-center">Teaching Feedback Blackboard Analysis</h1>

    <!-- Data Input Panel -->
    <div id="input-panel" class="mb-8 p-4 border border-dashed border-gray-500 rounded-lg">
        <label for="csv-input" class="block mb-2 font-semibold chalk">Paste CSV Data Below (Live Update)</label>
        <textarea id="csv-input" class="w-full chalk-input p-3 text-sm rounded-md" placeholder="Paste your CSV content here from the spreadsheet (including the header row)..."></textarea>
        <button id="analyze-button" class="chalk-button px-6 py-2 rounded-lg mt-4 w-full md:w-auto font-bold">Analyze & Update Blackboard</button>
        <p class="text-xs mt-2 text-gray-400">The first analysis runs on the pre-loaded data. Use this box to update the analysis with new data.</p>
    </div>

    <!-- Quantitative Metrics Panel -->
    <h2 class="text-2xl font-bold chalk-header mb-6">1. Quantitative Metrics</h2>
    <div id="quantitative-output" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
        <div id="summary-section" class="col-span-1 md:col-span-2">
            <p class="text-xl font-semibold mb-4 text-center text-gray-300">Total Responses: <span id="response-count" class="text-2xl text-[#F0E68C]">0</span></p>
            <div id="subject-breakdown" class="flex flex-wrap justify-center space-x-4"></div>
        </div>
    </div>

    <!-- Qualitative Analysis Panel (LLM Output) -->
    <h2 class="text-2xl font-bold chalk-header mb-6">2. Qualitative Analysis (Themed Feedback)</h2>
    <div id="analysis-output" class="p-6 rounded-lg bg-black bg-opacity-30">
        <p id="analysis-status" class="text-center italic text-lg text-gray-400">
            Click 'Analyze & Update Blackboard' to process feedback themes.
        </p>
    </div>

</div>

<script type="module">
    // --- Configuration and Data ---
    const apiKey = "";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    // IMPORTANT: The raw CSV content from the uploaded file is embedded here.
    const initialCsvData = `Timestamp,What do I teach you?,How clearly do I explain the lessons?,How interesting are the lessons?,Do I use different ways to explain things? e.g. videos/activities/examples,Do I encourage you to ask questions or participate in class?,"How much do you enjoy participating in class activities? e.g. pair work, group work, class discussions",Do I make learning engaging and enjoyable?,How quickly do I give feedback on work or assignments?,Do I help you when you don’t understand something? ,How comfortable do you feel asking for help in class?,Do I create an environment where you feel safe and heard?,What do you like most about how I teach?,What do you think could be improved about how I teach?,Any other comments or suggestions for me?
04/03/2025 15:43:06,Music,Clear,Interesting,Always,Always,A Lot,Often,Very Quickly,Always,Very Comfortable,Always,"How comfortable it is. It's not a scary environment. The music room is just really chill and Phil is also great to be around and have as a teacher.","Nothing","Favourite teacher for sure "
04/03/2025 22:05:45,Ako,Very Clear,Neutral,Often,Sometimes,A Lot,Often,Quickly,Always,Comfortable,Often,Friendly and relatable,Not sure,No
05/03/2025 09:18:13,Music,Clear,Interesting,Often,Always,Often,A Lot,Very Quickly,Always,Very Comfortable,Always,"Always help, and engaging","nothing","no"
05/03/2025 09:29:21,Music,Clear,Interesting,Sometimes,Often,Often,Often,Quickly,Always,Comfortable,Always,"you think of things in a teens  pov so it helps us understand better ","i dont think anything needs to be inproved, you could maybe be strickter on kids who arnt doing as theyere asked but then they might not like you lol","no :) i think your great "
06/03/2025 09:29:55,Ako,Clear,Very Interesting,Often,Always,A Lot,A Lot,On Time,Always,Very Comfortable,Always,"You are very straightforward and don't mess about. You just get what needs to be done, done.","Not much, you are a great Ako teacher :)","Nope"
11/03/2025 14:23:54,Music,Okay,Interesting,Often,Sometimes,A Little,A Lot,On Time,Sometimes,Comfortable,Often,practical,use text books or something on how to read music,nope
12/03/2025 12:57:30,Music,Clear,Very Interesting,Often,Often,Often,A Lot,On Time,Sometimes,Very Comfortable,Always,I enjoy the practicals and sometimes the theory. ,-, -
14/03/2025 11:49:33,Music,Very Clear,Very Interesting,Always,Often,A Lot,Often,Quickly,Sometimes,Not Comfortable,Always,everything,nothing , let me game more in class ands not do any lreaning 
26/03/2025 12:50:51,Music,Clear,Neutral,Always,Always,A Lot,Often,On Time,Always,Very Comfortable,Always,I enjoy that he is not a strict teacher and doesn't get frustrated or angry if we get the wrong answer or don't know something.,The theory work is a bit hard and confusing,No
27/03/2025 08:31:07,Music,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,I like the way you teach with hands on and clear instructions.,Nothing,No
27/03/2025 12:44:48,Ako,Clear,Neutral,Often,Always,Often,Often,On Time,Always,Comfortable,Always,you can relate to students,nothing,I like this class
27/03/2025 12:44:48,Ako,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Comfortable,Always,He is very supportive of his students, Nothing, N/A
28/03/2025 10:14:04,Music,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,He helps us out a lot with our mahi and teaches us how to play instruments.,No,He is one of the best teachers I've ever had.
01/04/2025 13:00:00,Music,Clear,Interesting,Often,Often,A Little,Often,Quickly,Always,Comfortable,Always,"I like that he gives us time to talk and catch up on work we have missed, and that he is very clear about the content being taught.",-, -
01/04/2025 13:00:00,Music,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,"I like how you let us know what we are doing in class so that we can be prepared for the lesson.","Nothing to improve, best teacher ever!", No
01/04/2025 13:00:00,Ako,Clear,Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,He is very helpful, N/A, N/A
01/04/2025 13:00:00,Ako,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,Teaching is really interesting, N/A, N/A
01/04/2025 13:00:00,Music,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,"The way he talks to us about the topic, and helps us understand the importance of the work we are doing.","Maybe talk a little slower, but that's ok", No
01/04/2025 13:00:00,Music,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,Helpful and supportive, No, No
01/04/2025 13:00:00,Music,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,"Your not strict, you are very nice.", N/A, N/A
01/04/2025 13:00:00,Music,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,Good explanations, N/A, N/A
01/04/2025 13:00:00,Music,Clear,Interesting,Often,Often,Often,Often,Quickly,Always,Comfortable,Always,"I like how you explain things so we can understand them, and how you check in with us to make sure we are not stuck.","Maybe try to make theory more engaging, but it's okay", N/A
01/04/2025 13:00:00,Music,Clear,Interesting,Often,Always,Often,Often,On Time,Always,Comfortable,Always,"I like how you are very clear with what we are doing, and how you help us when we are stuck.","Maybe try to be a bit more strict with the class, because some people mess around and don't get work done.", N/A
01/04/2025 13:00:00,Music,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,"I like how you teach us new things, and how you are very supportive.", N/A, N/A
01/04/2025 13:00:00,Music,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,I like how you help us with our work and explain things clearly., N/A, N/A
01/04/2025 13:00:00,Music,Very Clear,Very Interesting,Always,Always,A Lot,Always,Very Quickly,Always,Very Comfortable,Always,I like how you are very supportive and helpful., N/A, N/A`;

    // Map for consolidating various positive responses into a single 'max' category for charts
    const MAX_MAP = {
        'Very Clear': 1, 'Very Interesting': 1, 'Always': 1, 'Very Quickly': 1, 'Very Comfortable': 1, 'A Lot': 1,
        'Clear': 0.75, 'Interesting': 0.75, 'Often': 0.75, 'Quickly': 0.75, 'Comfortable': 0.75,
        'Okay': 0.5, 'Neutral': 0.5, 'Sometimes': 0.5, 'On Time': 0.5, 'A Little': 0.5,
        'Not Comfortable': 0.25,
    };

    // --- DOM Elements ---
    const analyzeButton = document.getElementById('analyze-button');
    const csvInput = document.getElementById('csv-input');
    const quantitativeOutput = document.getElementById('quantitative-output');
    const analysisOutput = document.getElementById('analysis-output');
    const responseCountElement = document.getElementById('response-count');
    const subjectBreakdownElement = document.getElementById('subject-breakdown');

    // --- Utility Functions ---

    /**
     * Robust CSV parsing function (handles quoted fields)
     * @param {string} csvText
     * @returns {Array<Object>} Array of objects where keys are column headers
     */
    function parseCSV(csvText) {
        if (!csvText || typeof csvText !== 'string') return [];
        const lines = csvText.split('\n').filter(line => line.trim() !== '');

        if (lines.length < 1) return [];

        // Simple split for headers, assuming header row does not contain newlines or complex escaping
        const headers = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.trim().replace(/"/g, ''));
        const results = [];

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            // Split line by comma, but not if the comma is inside double quotes
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const row = {};

            if (values.length !== headers.length) {
                // console.warn(`Skipping line ${i + 1} due to inconsistent column count: ${values.length} vs ${headers.length}`);
                continue;
            }

            values.forEach((value, j) => {
                // Remove surrounding quotes and trim
                row[headers[j]] = value.trim().replace(/^"|"$/g, '').trim();
            });
            results.push(row);
        }
        return results;
    }

    // --- Quantitative Analysis ---

    /**
     * Processes quantitative (Likert/Frequency) data for charting.
     * @param {Array<Object>} data
     */
    function processQuantitative(data) {
        if (data.length === 0) {
            quantitativeOutput.innerHTML = '<p class="text-center text-gray-400">No data found to analyze.</p>';
            return {};
        }

        const quantitativeQuestions = headers.slice(2, 12); // Columns 3 to 12 are quantitative
        const allResults = {};

        // 1. Calculate Question Metrics (Counts for each response)
        quantitativeQuestions.forEach(question => {
            const counts = {};
            data.forEach(row => {
                const response = row[question];
                if (response) {
                    counts[response] = (counts[response] || 0) + 1;
                }
            });
            allResults[question] = counts;
        });

        // 2. Calculate Subject Breakdown
        const subjectCounts = {};
        data.forEach(row => {
            const subject = row['What do I teach you?'];
            subjectCounts[subject] = (subjectCounts[subject] || 0) + 1;
        });

        // 3. Render
        renderQuantitative(data.length, allResults, subjectCounts);

        return allResults;
    }

    /**
     * Renders the quantitative data as bar charts.
     */
    function renderQuantitative(totalResponses, allResults, subjectCounts) {
        responseCountElement.textContent = totalResponses;
        quantitativeOutput.innerHTML = '';
        subjectBreakdownElement.innerHTML = '';

        // Render Subject Breakdown
        Object.entries(subjectCounts).forEach(([subject, count]) => {
            const percentage = ((count / totalResponses) * 100).toFixed(0);
            const breakdownHtml = `
                <div class="flex items-center space-x-2 text-sm">
                    <span class="font-bold text-[#F0E68C]">${subject}</span>
                    <span class="text-gray-400">(${count})</span>
                    <span class="text-white">| ${percentage}%</span>
                </div>
            `;
            subjectBreakdownElement.insertAdjacentHTML('beforeend', breakdownHtml);
        });

        // Render Bar Charts
        Object.entries(allResults).forEach(([question, counts]) => {
            const total = Object.values(counts).reduce((sum, count) => sum + count, 0);
            let barHtml = '';

            // Sort responses by their 'MAX_MAP' value for a logical chart order
            const sortedResponses = Object.keys(counts).sort((a, b) => (MAX_MAP[b] || 0) - (MAX_MAP[a] || 0));

            sortedResponses.forEach(response => {
                const count = counts[response];
                const percentage = total > 0 ? ((count / total) * 100) : 0;
                const barColor = (MAX_MAP[response] >= 0.75) ? 'bg-green-500' :
                                 (MAX_MAP[response] >= 0.5) ? 'bg-yellow-500' :
                                 'bg-red-500';

                barHtml += `
                    <div class="mb-2">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="w-1/3 text-gray-400 pr-2">${response}</span>
                            <span class="w-1/6 text-right font-bold">${count}</span>
                            <span class="w-1/6 text-right">${percentage.toFixed(0)}%</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar ${barColor}" style="width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
            });

            const questionHtml = `
                <div class="p-4 border border-gray-700 rounded-lg bg-black bg-opacity-10">
                    <h3 class="text-sm font-semibold mb-3 text-gray-200">${question}</h3>
                    ${barHtml}
                </div>
            `;
            quantitativeOutput.insertAdjacentHTML('beforeend', questionHtml);
        });
    }

    // --- Qualitative Analysis (LLM) ---

    /**
     * Calls Gemini API to summarize open-ended feedback.
     * @param {Array<Object>} data
     */
    async function analyzeQualitative(data) {
        analysisOutput.innerHTML = '<p id="analysis-status" class="text-center italic text-lg text-[#F0E68C] animate-pulse">Analyzing feedback themes with Gemini... Please wait.</p>';
        analyzeButton.disabled = true;

        if (data.length === 0) {
            analysisOutput.innerHTML = '<p class="text-center italic text-lg text-gray-400">No responses to analyze.</p>';
            analyzeButton.disabled = false;
            return;
        }

        const improvementComments = data.map(row => row['What do you think could be improved about how I teach?']).filter(c => c && c.trim() !== '-' && c.trim().toLowerCase() !== 'nothing' && c.trim().toLowerCase() !== 'n/a');
        const positiveComments = data.map(row => row['What do you like most about how I teach?']).filter(c => c && c.trim() !== '-' && c.trim().toLowerCase() !== 'everything' && c.trim().toLowerCase() !== 'n/a');

        const systemPrompt = `You are a helpful, professional educational coach and data analyst. Your task is to analyze the raw student feedback provided in CSV format to provide constructive, themed insights for the teacher.
The data is structured as two columns:
1. "Positive Comments": What students like most about the teaching.
2. "Improvement Comments": What students think could be improved.

Your goal is to:
1. Create 3-5 major themes for the "Positive Comments."
2. Create 3-5 major themes for the "Improvement Comments."
3. For each theme, provide 1-2 example quotes from the raw data.
4. Be encouraging and action-oriented in your summary.

The output MUST be in clear, clean Markdown format.`;

        const userQuery = `Analyze the following raw student feedback data:

--- Positive Comments ---
${positiveComments.join('\n- ')}

--- Improvement Comments ---
${improvementComments.join('\n- ')}
`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                })
            });

            if (!response.ok) throw new Error(`API response error: ${response.statusText}`);

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Analysis failed to produce text.";
            analysisOutput.innerHTML = text;

        } catch (error) {
            console.error("Gemini API Error:", error);
            analysisOutput.innerHTML = `<p class="text-center text-red-400">Analysis failed: ${error.message}</p>`;
        } finally {
            analyzeButton.disabled = false;
        }
    }

    // --- Main Logic ---

    let headers = [];

    /**
     * Main function to load data, process, and render.
     * @param {string} csv
     */
    async function startAnalysis(csv) {
        const data = parseCSV(csv);
        if (data.length > 0) {
            headers = Object.keys(data[0]);
            // Run Quantitative (charts)
            processQuantitative(data);
            // Run Qualitative (LLM themes)
            await analyzeQualitative(data);
        } else {
            quantitativeOutput.innerHTML = '<p class="text-center text-gray-400">No valid data found in the input.</p>';
            analysisOutput.innerHTML = '<p class="text-center italic text-lg text-gray-400">No responses to analyze.</p>';
        }
    }

    // Event listener for the button
    analyzeButton.addEventListener('click', () => {
        const updatedCsv = csvInput.value.trim();
        if (updatedCsv) {
            startAnalysis(updatedCsv);
        } else {
            // Error handling or just re-run initial analysis if input is cleared
            // console.log("Input is empty, running initial data analysis.");
            startAnalysis(initialCsvData);
        }
    });

    // Initialize the app with the pre-loaded data
    window.onload = () => {
        csvInput.value = initialCsvData; // Pre-fill the box for user visibility
        startAnalysis(initialCsvData);
    };

</script>
</body>
</html>
