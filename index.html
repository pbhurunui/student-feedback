<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data-Driven Unit Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Lucide Icons -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="text-center pb-6 mb-8 border-b-2 border-indigo-200">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-700 tracking-tight">
                Data-Driven Unit Planner
            </h1>
            <p class="mt-2 text-xl text-gray-600">
                Analyze feedback & generate actionable Term 4 plans with AI.
            </p>
        </header>

        <!-- Loading and Subject Selection -->
        <div id="status-area" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <div id="loading-message" class="flex items-center justify-center space-x-3 text-lg font-medium text-indigo-600">
                <svg class="animate-spin h-5 w-5 mr-3 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="loader-text">Loading and Combining Feedback Data...</span>
            </div>
            
            <div id="controls-area" class="hidden flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
                <p id="data-summary" class="text-sm font-medium text-green-700"></p>

                <div class="flex items-center space-x-3">
                    <label for="subject-select" class="font-medium text-gray-700">Select Subject:</label>
                    <select id="subject-select" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition"></select>
                    <button id="analyze-button" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-md disabled:opacity-50" disabled>
                        Analyze Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Analysis and Output Area -->
        <div id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
            <!-- Column 1 & 2: Feedback Analysis -->
            <div class="lg:col-span-2 space-y-8">
                <h2 class="text-3xl font-bold text-gray-800">Feedback Analysis</h2>
                
                <!-- Metric Cards -->
                <div id="metric-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Cards will be populated here -->
                </div>

                <!-- Open Feedback -->
                <div class="grid md:grid-cols-2 gap-4">
                    <!-- Note: max-h-96 now applied to show more content -->
                    <div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-green-500">
                        <h3 class="text-xl font-bold mb-3 flex items-center text-green-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.765l-2.03-2.03m0 0l-2.03-2.03M16.765 7.97V4"></path></svg>
                            All Positive Comments
                        </h3>
                        <ul id="likes-list" class="list-disc pl-5 space-y-2 text-gray-700 max-h-96 overflow-y-auto"></ul>
                    </div>
                    
                    <div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-red-500">
                        <h3 class="text-xl font-bold mb-3 flex items-center text-red-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.765l-2.03-2.03m0 0l-2.03-2.03M16.765 7.97V4"></path></svg>
                            All Areas for Improvement
                        </h3>
                        <ul id="improvements-list" class="list-disc pl-5 space-y-2 text-gray-700 max-h-96 overflow-y-auto"></ul>
                    </div>
                </div>
            </div>

            <!-- Column 3: AI Generator -->
            <div class="lg:col-span-1 space-y-6 bg-white p-6 rounded-xl shadow-2xl sticky top-4 h-fit">
                <h2 class="text-3xl font-bold text-indigo-800 mb-4">
                    Generate Term 4 Unit Plan
                </h2>

                <p class="text-sm text-gray-600">
                    Use the analyzed feedback to generate a targeted Unit Plan (Term 4) that addresses student concerns.
                </p>

                <button id="generate-plan-button" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/50 disabled:opacity-50" disabled>
                    Generate Plan
                </button>

                <!-- Plan Output Area -->
                <div id="plan-output" class="mt-6 border-t pt-4 border-gray-200">
                    <div id="plan-loader" class="hidden items-center justify-center space-x-3 text-indigo-600 py-10">
                        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Generating plan, please wait...</span>
                    </div>
                    <div id="generated-content" class="prose max-w-none text-gray-700">
                        <p class="text-center italic text-gray-400">Click 'Generate Plan' to create your data-driven curriculum.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global Data Store
        let fullData = [];
        let subjects = new Set();
        let currentAnalysis = null;
        const LLM_MODEL = "gemini-2.5-flash-preview-05-20";
        const API_KEY = ""; // Kept empty as per instructions

        // CSV File Contents (Hardcoded from user's provided snippets)
        const csvFiles = [
            { name: "Student Feedback 2025 T3 (Responses) - Form responses 1.csv", content: `Timestamp,What do I teach you?,How clearly do I explain the lessons?,How interesting are the lessons?,Do I use different ways to explain things? e.g. videos/activities/examples,Do I encourage you to ask questions or participate in class?,"How much do you enjoy participating in class activities? e.g. pair work, group work, class discussions",Do I make learning engaging and enjoyable?,How quickly do I give feedback on work or assignments?,Do I help you when you don’t understand something? ,How comfortable do you feel asking for help in class?,Do I create an environment where you feel safe and heard?,What do you like most about how I teach?,What do you think could be improved about how I teach?,Any other comments or suggestions for me?\r\n07/10/2025 16:19:25,Music,Clear,Interesting,Often,Always,Often,A Lot,Very Quickly,Always,Very Comfortable,Always,How supportive you are,Nothing,Nope\r\n07/10/2025 16:29:02,"Ako, Music",Clear,Neutral,Often,Often,Often,Often,Very Quickly,Always,Very Comfortable,Always,U are straight to the point and short and clear on explaining things,Unsure,Very quick to get back results and feedback \r\n07/10/2025 16:30:41,Music,Very Clear,Interesting,Sometimes,Often,Sometimes,Often,Very Quickly,Often,Very Comfortable,Always,How approachable and respectful you are to students. Treated like equals and how understanding you are.,"Certain days, certain topics in classes.",Nah\r\n15/10/2025 14:45:30,"Music, Digital Technology",Clear,Interesting,Sometimes,Always,A Lot,Often,Very Quickly,Always,Very Comfortable,Always,your laid back and you always try to see our point of views and if we don't understand you always try to explain it in a different way so we do understand  ,"maybe have more fun activities that are to do with learning espily with theory, like when we did quizlet, that was fun and engaging and it helped me and others learn a lot of theory...`},
            { name: "Student Feedback 2025 T1 (Responses) - Form responses 1.csv", content: `Timestamp,What do I teach you?,How clearly do I explain the lessons?,How interesting are the lessons?,Do I use different ways to explain things? e.g. videos/activities/examples,Do I encourage you to ask questions or participate in class?,"How much do you enjoy participating in class activities? e.g. pair work, group work, class discussions",Do I make learning engaging and enjoyable?,How quickly do I give feedback on work or assignments?,Do I help you when you don’t understand something? ,How comfortable do you feel asking for help in class?,Do I create an environment where you feel safe and heard?,What do you like most about how I teach?,What do you think could be improved about how I teach?,Any other comments or suggestions for me?\r\n04/03/2025 15:43:06,Music,Clear,Interesting,Always,Always,A Lot,Often,Very Quickly,Always,Very Comfortable,Always,How comfortable it is. It's not a scary environment. The music room is just really chill and Phil is also great to be around and have as a teacher.,Nothing,Favourite teacher for sure \r\n04/03/2025 22:05:45,Ako,Very Clear,Neutral,Often,Sometimes,A Lot,Often,Quickly,Always,Comfortable,Often,Friendly and relatable,Not sure,No\r\n05/03/2025 09:18:13,Music,Clear,Interesting,Often,Always,Often,A Lot,Very Quickly,Always,Very Comfortable,Always,"Always help, and engaging",nothing,no\r\n14/03/2025 11:49:33,Music,Very Clear,Very Interesting,Always,Often,A Lot,Often,Quickly,Sometimes,Not Comfortable,Always,everything,nothing , let me game more in class ands not do any lreaning \r\n26/03/2025 12:50:51,Music,Clear,Interesting,Sometimes,Often,Often,Often,Quickly,Always,Comfortable,Always,you think of things in a teens  pov so it helps us understand better ,"i dont think anything needs to be inproved, you could maybe be strickter on kids who arnt doing as theyere asked but then they might not like you lol",no :) i think your great`},
        ];

        // --- Utility Functions ---

        /** Finds the most frequent value in an array. */
        function getMode(arr) {
            const counts = arr.reduce((acc, value) => {
                acc[value] = (acc[value] || 0) + 1;
                return acc;
            }, {});
            let maxCount = 0;
            let mode = '';
            for (const key in counts) {
                if (counts[key] > maxCount) {
                    maxCount = counts[key];
                    mode = key;
                }
            }
            return mode || 'N/A';
        }

        /** Simple markdown to HTML conversion for LLM output. */
        function markdownToHtml(markdown) {
            // Convert headers
            let html = markdown.replace(/^###\s*(.*)$/gm, '<h3>$1</h3>');
            html = html.replace(/^##\s*(.*)$/gm, '<h2>$1</h2>');
            html = html.replace(/^#\s*(.*)$/gm, '<h1>$1</h1>');
            // Convert bold/italic
            html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Convert unordered lists
            html = html.replace(/^\s*-\s+(.*)$/gm, '<li>$1</li>');
            html = html.replace(/((<li>.*<\/li>\n*)+)/g, '<ul>$1</ul>').replace(/<\/ul>\n<ul>/g, ''); // Wrap in <ul>
            // Convert paragraphs (lines not starting with <h, <ul, <li)
            html = html.split('\n').map(line => {
                if (line.trim() && !line.startsWith('<h') && !line.startsWith('<ul') && !line.startsWith('<li')) {
                    return `<p>${line}</p>`;
                }
                return line;
            }).join('\n');
            return html;
        }

        /** Generates a base LLM analysis structure for a subject. */
        function analyzeSubjectData(subjectName, data) {
            const subjectData = data.filter(row => {
                const taught = row['What do I teach you?'] || '';
                return taught.split(',').map(s => s.trim()).includes(subjectName);
            });

            const totalResponses = subjectData.length;
            if (totalResponses === 0) return null;

            const keyMetrics = {
                'Clarity': 'How clearly do I explain the lessons?',
                'Engagement': 'How interesting are the lessons?',
                'Differentiation': 'Do I use different ways to explain things? e.g. videos/activities/examples',
                'Participation': 'Do I encourage you to ask questions or participate in class?',
                'Comfort': 'How comfortable do you feel asking for help in class?',
                'FeedbackSpeed': 'How quickly do I give feedback on work or assignments?',
            };

            const metricResults = {};

            for (const [metricKey, columnHeader] of Object.entries(keyMetrics)) {
                const responses = subjectData.map(row => row[columnHeader]).filter(v => v);
                metricResults[metricKey] = {
                    mode: getMode(responses),
                    count: responses.length,
                    responses: responses
                };
            }

            const likes = subjectData.map(row => row['What do you like most about how I teach?']).filter(v => v);
            const improvements = subjectData.map(row => row['What do you think could be improved about how I teach?']).filter(v => v && v.toLowerCase() !== 'nothing' && v.toLowerCase() !== 'nope' && v.toLowerCase() !== '-');

            return {
                subjectName,
                totalResponses,
                metricResults,
                likes,
                improvements
            };
        }
        
        // --- DOM Update Functions ---

        function updateMetricCards(analysis) {
            const container = document.getElementById('metric-cards');
            container.innerHTML = '';
            
            const metricColors = {
                'Clarity': 'bg-indigo-100 border-indigo-500 text-indigo-700',
                'Engagement': 'bg-pink-100 border-pink-500 text-pink-700',
                'Differentiation': 'bg-yellow-100 border-yellow-500 text-yellow-700',
                'Participation': 'bg-green-100 border-green-500 text-green-700',
                'Comfort': 'bg-purple-100 border-purple-500 text-purple-700',
                'FeedbackSpeed': 'bg-teal-100 border-teal-500 text-teal-700',
            };

            Object.entries(analysis.metricResults).forEach(([key, result]) => {
                const cardClass = metricColors[key] || 'bg-gray-100 border-gray-500 text-gray-700';
                const cardHtml = `
                    <div class="p-4 rounded-xl shadow-md border-b-4 ${cardClass}">
                        <p class="text-sm font-semibold uppercase">${key}</p>
                        <p class="text-3xl font-bold mt-1">${result.mode}</p>
                        <p class="text-xs opacity-70 mt-1">${result.count} responses</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        function updateFeedbackLists(analysis) {
            const likesList = document.getElementById('likes-list');
            const improvementsList = document.getElementById('improvements-list');
            
            const renderList = (element, items, defaultMsg) => {
                element.innerHTML = '';
                if (items.length > 0) {
                    // Renders ALL items now, not just the top 5
                    items.forEach(item => {
                        element.insertAdjacentHTML('beforeend', `<li>${item}</li>`);
                    });
                } else {
                    element.innerHTML = `<li class="italic text-gray-400">${defaultMsg}</li>`;
                }
            };

            renderList(likesList, analysis.likes, 'No specific positive feedback provided.');
            renderList(improvementsList, analysis.improvements, 'No specific areas for improvement provided.');

            document.getElementById('generate-plan-button').disabled = false;
        }

        // --- Data Loading and Initialization ---

        function parseAndCombineData() {
            let combinedData = [];
            let totalResponses = 0;
            const promises = csvFiles.map(file => {
                return new Promise((resolve, reject) => {
                    Papa.parse(file.content, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length) {
                                console.error(`Error parsing ${file.name}:`, results.errors);
                                return resolve([]);
                            }
                            totalResponses += results.data.length;
                            resolve(results.data);
                        },
                        error: (error) => {
                            console.error(`Failed to process ${file.name}:`, error);
                            reject(error);
                        }
                    });
                });
            });

            Promise.all(promises).then(allResults => {
                allResults.forEach(data => {
                    combinedData = combinedData.concat(data.filter(row => 
                        // Basic check to ensure the row has the key column for filtering
                        (row['What do I teach you?'] || '').trim() !== '' 
                    ));
                });
                
                fullData = combinedData;
                extractSubjects();
                initializeUI(totalResponses);

            }).catch(e => {
                document.getElementById('loader-text').textContent = 'Error loading data.';
                console.error("Data loading failed:", e);
            });
        }

        function extractSubjects() {
            fullData.forEach(row => {
                const taught = row['What do I teach you?'] || '';
                taught.split(',').map(s => s.trim()).filter(s => s).forEach(s => subjects.add(s));
            });
        }

        function initializeUI(totalResponses) {
            document.getElementById('loading-message').classList.add('hidden');
            document.getElementById('controls-area').classList.remove('hidden');
            document.getElementById('data-summary').textContent = `Total combined responses loaded: ${totalResponses}.`;

            const select = document.getElementById('subject-select');
            select.innerHTML = '<option value="" disabled selected>-- Select Subject --</option>';
            
            [...subjects].sort().forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                select.appendChild(option);
            });

            select.addEventListener('change', handleSubjectChange);
            document.getElementById('analyze-button').addEventListener('click', runAnalysis);
            document.getElementById('generate-plan-button').addEventListener('click', generateUnitPlan);
        }

        // --- Event Handlers ---

        function handleSubjectChange(event) {
            const subject = event.target.value;
            if (subject) {
                document.getElementById('analyze-button').disabled = false;
                // Clear old analysis when subject changes
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('generated-content').innerHTML = '<p class="text-center italic text-gray-400">Click \'Generate Plan\' to create your data-driven curriculum.</p>';
            }
        }

        function runAnalysis() {
            const selectedSubject = document.getElementById('subject-select').value;
            if (!selectedSubject) return;

            const analysis = analyzeSubjectData(selectedSubject, fullData);

            if (analysis && analysis.totalResponses > 0) {
                currentAnalysis = analysis;
                updateMetricCards(analysis);
                updateFeedbackLists(analysis);
                document.getElementById('main-content').classList.remove('hidden');
            } else {
                alert('No data found for this subject.');
                document.getElementById('main-content').classList.add('hidden');
            }
        }

        // --- LLM API Logic ---

        async function generateUnitPlan() {
            if (!currentAnalysis) return;

            const button = document.getElementById('generate-plan-button');
            const loader = document.getElementById('plan-loader');
            const outputDiv = document.getElementById('generated-content');

            button.disabled = true;
            loader.classList.remove('hidden');
            outputDiv.innerHTML = '';

            const analysis = currentAnalysis;
            
            const systemPrompt = "You are an expert secondary school curriculum designer and instructional coach. Your task is to generate a comprehensive, actionable Unit Plan for Term 4 based on the student feedback provided. The plan must specifically address the 'Areas for Improvement' identified by the students by integrating new teaching strategies and assessment methods. Focus on practical, engaging solutions. Structure your response using H2 (##) and H3 (###) headers and bullet points.";

            const userQuery = `
                Generate a Term 4 Unit Plan for the subject: ${analysis.subjectName}.
                The Unit Plan should be designed for a typical 8-week term and must be actionable.

                The plan should include the following sections in order:
                1. Unit Goal (1-2 sentences: overall learning outcome)
                2. Data Snapshot (Summary of key student feedback findings)
                3. Focus Areas for Term 4 (Must address student feedback and suggest specific, new strategies)
                4. Recommended Activities (3 specific, high-engagement, differentiated activities)
                5. Assessment Strategy (A mix of formative and summative, related to the focus areas)

                ---
                Student Feedback Summary (Must be incorporated and addressed in the plan):
                - Total Responses: ${analysis.totalResponses}
                - Most Common Clarity Feedback: ${analysis.metricResults.Clarity.mode}
                - Most Common Engagement Feedback: ${analysis.metricResults.Engagement.mode}
                - Most Common Comfort Feedback: ${analysis.metricResults.Comfort.mode}
                - Top 3 Likes: ${analysis.likes.slice(0, 3).join('; ')}
                - Top 3 Improvements: ${analysis.improvements.slice(0, 3).join('; ')}
            `;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${API_KEY}`;

            let attempts = 0;
            const maxAttempts = 5;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempts < maxAttempts - 1) {
                            const delay = Math.pow(2, attempts) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            attempts++;
                            continue;
                        }
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Error: Could not retrieve generated text.';

                    outputDiv.innerHTML = markdownToHtml(generatedText);
                    break; 

                } catch (error) {
                    outputDiv.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}. Please try again.</p>`;
                    console.error("LLM Generation Error:", error);
                    break;
                } finally {
                    loader.classList.add('hidden');
                    button.disabled = false;
                }
            }
        }

        // --- Application Bootstrap ---
        window.onload = parseAndCombineData;

    </script>
</body>
</html>
